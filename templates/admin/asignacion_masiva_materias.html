{% extends "base.html" %}

{% block title %}Asignación Masiva de Materias{% endblock %}
{% block body_class %}admin-ui{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="admin-page-title">
            <i class="fas fa-tasks me-2"></i>
            Asignación Masiva de Materias
        </h2>
        <div class="admin-page-actions">
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Volver al Dashboard
            </a>
            <a href="{{ url_for('importar_asignaciones_masivas') }}" class="btn btn-success">
                <i class="fas fa-file-upload me-1"></i>
                Importar CSV
            </a>
        </div>
    </div>

    <!-- Filtros y Herramientas -->
    <div class="card mb-4">
        <div class="card-header admin-section-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>
                Filtros de Búsqueda
            </h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('asignacion_masiva_materias') }}" id="filtrosForm" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label text-muted small fw-bold">CARRERA</label>
                    <select name="carrera" id="carrera" class="form-select border-0 shadow-sm" onchange="this.form.submit()">
                        <option value="">Todas las carreras</option>
                        {% for carrera in carreras %}
                        <option value="{{ carrera.id }}" {% if filtro_carrera == carrera.id %}selected{% endif %}>
                            {{ carrera.codigo }} - {{ carrera.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label text-muted small fw-bold">CUATRIMESTRE</label>
                    <select name="cuatrimestre" id="cuatrimestre" class="form-select border-0 shadow-sm" onchange="this.form.submit()">
                        <option value="">Todos los cuatrimestres</option>
                        {% for i in range(0, 11) %}
                        <option value="{{ i }}" {% if filtro_cuatrimestre == i %}selected{% endif %}>
                            {% if i == 0 %}Propedéutico (0){% else %}Cuatrimestre {{ i }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                   <div class="form-check form-switch pt-3">
                        <input class="form-check-input" type="checkbox" name="solo_disponibles" value="1" 
                               id="soloDisponibles" {% if solo_disponibles %}checked{% endif %} onchange="this.form.submit()">
                        <label class="form-check-label" for="soloDisponibles">Solo con disponibilidad</label>
                   </div>
                </div>
                <div class="col-md-3 text-end">
                    {% if filtro_carrera %}
                    <button type="button" class="btn btn-warning text-white shadow-sm btn-sm" onclick="autoAsignarCarrera()">
                        <i class="fas fa-robot me-1"></i> Auto-Asignar
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-outline-info btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#ayudaModal">
                        <i class="fas fa-question-circle"></i> Ayuda
                    </button>
                    {% if filtro_carrera or filtro_cuatrimestre %}
                        <a href="{{ url_for('asignacion_masiva_materias') }}" class="btn btn-link btn-sm text-muted text-decoration-none">
                            Limpiar Filtros
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white admin-stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ profesores|length }}</h4>
                            <p class="mb-0">Profesores</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chalkboard-teacher fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white admin-stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ materias|length }}</h4>
                            <p class="mb-0">Materias</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-book fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white admin-stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0" id="contadorCambios">0</h4>
                            <p class="mb-0">Cambios</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-edit fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark admin-stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ asignaciones_actuales.values() | map('length') | sum }}</h4>
                            <p class="mb-0">Total Asignado</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-link fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if profesores and materias %}
    <form method="POST" action="{{ url_for('asignacion_masiva_materias', carrera=filtro_carrera if filtro_carrera else '', cuatrimestre=filtro_cuatrimestre if filtro_cuatrimestre else '') }}" id="formAsignacion">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="card border-0 shadow-sm">
            
            <!-- Barra de Acciones de la Matriz -->
            <div class="card-header bg-white py-3 border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-dark fw-bold">
                        <i class="fas fa-th me-2 text-secondary"></i>Matriz de Asignaciones
                    </h5>
                    <div class="d-flex gap-2">
                        <div class="btn-group shadow-sm">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="seleccionarTodas()" title="Seleccionar todo">
                                <i class="fas fa-check-double"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limpiarSeleccion()" title="Limpiar">
                                <i class="fas fa-eraser"></i>
                            </button>
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm shadow-sm px-4 fw-bold" id="btnGuardar">
                            <i class="fas fa-save me-1"></i> Guardar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Matriz -->
            <div class="card-body p-0">
                <div class="table-responsive bg-white mass-matrix-container">
                    <table class="table table-bordered mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th class="p-3 border-0 bg-dark mass-sticky-col-title">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="text-uppercase small fw-bold tracking-wider">Profesor</span>
                                        <i class="fas fa-check cursor-pointer opacity-50 hover-opacity-100" onclick="seleccionarColumna(-1)"></i>
                                    </div>
                                </th>
                                {% for materia in materias %}
                                <th class="text-center p-2 border-secondary align-middle bg-dark mass-materia-col">
                                    <div class="d-flex flex-column align-items-center cursor-pointer group-hover-target" onclick="seleccionarColumna({{ loop.index0 }})">
                                        <span class="badge bg-secondary mb-1 metric-label-xs">C{{ materia.cuatrimestre }}</span>
                                        <small class="d-block lh-sm text-truncate w-100 mass-materia-label" title="{{ materia.nombre }}">
                                            {{ materia.codigo }}<br>
                                            {{ materia.nombre }}
                                        </small>
                                        <i class="fas fa-caret-down mt-1 opacity-25 group-hover-visible"></i>
                                    </div>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for profesor in profesores %}
                            {% set carga = cargas_profesores[profesor.id] %}
                            {% set en_limite = carga.porcentaje >= 100 %}
                            <tr class="align-middle {{ 'table-danger' if en_limite else '' }}">
                                <!-- Columna Sticky Profesor -->
                                <th class="p-3 border-end {{ 'bg-danger bg-opacity-10' if en_limite else 'bg-white' }} mass-sticky-col-body">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3 position-relative">
                                            {% if profesor.imagen_perfil %}
                                                <img src="{{ url_for('static', filename='uploads/perfiles/' + profesor.imagen_perfil) }}" class="rounded-circle" width="40" height="40">
                                            {% else %}
                                                <div class="avatar-circle-sm bg-light text-primary fw-bold">{{ profesor.nombre[0] }}{{ profesor.apellido[0] }}</div>
                                            {% endif %}
                                            <span class="position-absolute bottom-0 end-0 p-1 bg-{{ 'success' if carga.porcentaje < 80 else 'warning' if carga.porcentaje < 100 else 'danger' }} border border-white rounded-circle">
                                                <span class="visually-hidden">Estado</span>
                                            </span>
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <div class="d-flex justify-content-between align-items-center cursor-pointer" onclick="seleccionarFila({{ profesor.id }})">
                                                <h6 class="mb-0 text-truncate text-dark" title="{{ profesor.get_nombre_completo() }}">
                                                    {{ profesor.nombre }} {{ profesor.apellido }}
                                                    {% if en_limite %}
                                                    <i class="fas fa-exclamation-triangle text-danger ms-1" title="Profesor en su límite de horas"></i>
                                                    {% endif %}
                                                </h6>
                                            </div>
                                            <div class="d-flex align-items-center mt-1">
                                                <div class="progress flex-grow-1 me-2 mass-progress-xs">
                                                    <div class="progress-bar bg-{{ carga.color }}" style="width: {{ [carga.porcentaje, 100]|min }}%"></div>
                                                </div>
                                                <small class="{{ 'text-danger fw-bold' if en_limite else 'text-muted' }} metric-label-xs" title="Horas asignadas: {{ carga.total_horas }}h | Límite: {{ carga.limite_maximo }}h{% if carga.horas_horarios != carga.total_horas %} | Horarios generados: {{ carga.horas_horarios }}h{% endif %}">
                                                    {{ carga.total_horas }}/{{ carga.limite_maximo }}h
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </th>
                                
                                <!-- Celdas de Materias -->
                                {% for materia in materias %}
                                <td class="text-center p-0 position-relative cell-hover">
                                    {% set esta_asignada = materia.id in asignaciones_actuales.get(profesor.id, []) %}
                                    {% set puede_asignar = carga.puede_mas or esta_asignada %}
                                    <label class="d-flex align-items-center justify-content-center w-100 h-100 py-3 {{ 'cursor-pointer' if puede_asignar else 'cursor-not-allowed' }} {{ 'bg-primary bg-opacity-10' if esta_asignada else '' }} {{ 'bg-secondary bg-opacity-10' if not puede_asignar and not esta_asignada else '' }}">
                                        <input type="checkbox"
                                                                                             class="form-check-input assignment-check border-2 mass-check-size"
                                               name="asignaciones[]"
                                               value="{{ profesor.id }}-{{ materia.id }}"
                                               data-profesor="{{ profesor.id }}"
                                               data-materia="{{ materia.id }}"
                                               data-columna="{{ loop.index0 }}"
                                               data-horas-materia="{{ materia.horas_semanales or 3 }}"
                                               data-puede-mas="{{ 'true' if carga.puede_mas else 'false' }}"
                                               data-horas-actuales="{{ carga.total_horas }}"
                                               data-limite="{{ carga.limite_maximo }}"
                                               onchange="actualizarContador(this)"
                                               {% if esta_asignada %}checked{% endif %}
                                               {% if not puede_asignar and not esta_asignada %}disabled title="El profesor ha alcanzado su límite de horas ({{ carga.total_horas }}/{{ carga.limite_maximo }}h)"{% endif %}>
                                    </label>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card-footer bg-light py-3">
                 <div class="d-flex justify-content-between align-items-center text-muted small flex-wrap gap-2">
                     <div>
                         <span class="badge bg-primary me-1">TC</span> Tiempo Completo
                         <span class="badge bg-info ms-2 me-1">PA</span> Por Asignatura
                     </div>
                     <div class="d-flex align-items-center gap-3">
                         <span><i class="fas fa-circle text-success me-1 tiny-dot"></i> Disponible</span>
                         <span><i class="fas fa-circle text-warning me-1 tiny-dot"></i> Alta carga</span>
                         <span><i class="fas fa-circle text-danger me-1 tiny-dot"></i> En límite (no se puede asignar más)</span>
                     </div>
                     <div>
                         <i class="fas fa-info-circle me-1"></i>
                         Los cambios se resaltarán antes de guardar.
                     </div>
                 </div>
            </div>
        </div>
    </form>
    {% else %}
    <div class="alert alert-info border-0 shadow-sm d-flex align-items-center p-4">
        <i class="fas fa-search fa-2x me-3 text-info"></i>
        <div>
            <h5 class="alert-heading">No se encontraron resultados</h5>
            <p class="mb-0">Prueba ajustando los filtros de carrera y cuatrimestre para ver la matriz de asignación.</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Ayuda (Mantener igual pero styled) -->
{% include 'ayuda_modal_partial.html' ignore missing %} 

<script>
// Mantener la lógica JS existente pero limpiala si es necesario
const asignacionesOriginales = new Set();
{% for profesor_id, materias_ids in asignaciones_actuales.items() %}
    {% for materia_id in materias_ids %}
        asignacionesOriginales.add('{{ profesor_id }}-{{ materia_id }}');
    {% endfor %}
{% endfor %}

function actualizarContador(checkbox) {
    if(checkbox) {
        // Visual effect for change
        const cell = checkbox.closest('label');
        if(checkbox.checked) {
             // Check if it was originally checked
             const original = asignacionesOriginales.has(checkbox.value);
             cell.className = `d-flex align-items-center justify-content-center w-100 h-100 py-3 cursor-pointer ${original ? 'bg-primary bg-opacity-10' : 'bg-success bg-opacity-25'}`;
        } else {
             const original = asignacionesOriginales.has(checkbox.value);
             cell.className = `d-flex align-items-center justify-content-center w-100 h-100 py-3 cursor-pointer ${original ? 'bg-danger bg-opacity-10' : ''}`;
        }
    }

    const checkboxes = document.querySelectorAll('.assignment-check');
    const asignacionesActuales = new Set();
    
    checkboxes.forEach(cb => {
        if (cb.checked) {
            asignacionesActuales.add(cb.value);
        }
    });
    
    let cambios = 0;
    asignacionesActuales.forEach(valor => {
        if (!asignacionesOriginales.has(valor)) cambios++;
    });
    asignacionesOriginales.forEach(valor => {
        if (!asignacionesActuales.has(valor)) cambios++;
    });
    
    const contadorBadge = document.getElementById('contadorCambios');
    contadorBadge.textContent = cambios;
    
    // Animar badge si hay cambios
    if (cambios > 0) {
        contadorBadge.classList.add('text-danger');
    } else {
        contadorBadge.classList.remove('text-danger');
    }
}

function seleccionarTodas() {
    document.querySelectorAll('.assignment-check').forEach(cb => {
        cb.checked = true;
        actualizarContador(cb);
    });
}

function limpiarSeleccion() {
    document.querySelectorAll('.assignment-check').forEach(cb => {
        cb.checked = false;
        actualizarContador(cb);
    });
}

function seleccionarFila(profesorId) {
    const checkboxes = document.querySelectorAll(`[data-profesor="${profesorId}"]`);
    const todosSeleccionados = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => {
        cb.checked = !todosSeleccionados;
        actualizarContador(cb);
    });
}

function seleccionarColumna(columnaIndex) {
    const selector = columnaIndex === -1 ? '.assignment-check' : `[data-columna="${columnaIndex}"]`;
    const checkboxes = document.querySelectorAll(selector);
    const todosSeleccionados = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => {
        cb.checked = !todosSeleccionados;
        actualizarContador(cb);
    });
}

function autoAsignarCarrera() {
    if (!confirm('¿Auto-asignar materias equitativamente?')) return;
    // ... Implement logic or keep existing ajax call ...
    // Since this requires backend route, assuming it exists as in original code
    const formData = new FormData();
    formData.append('carrera_id', {{ filtro_carrera if filtro_carrera else 0 }});
    {% if filtro_cuatrimestre %}formData.append('cuatrimestre', {{ filtro_cuatrimestre }});{% endif %}
    
    secureFetch('{{ url_for("auto_asignar_por_carrera") }}', {method: 'POST', body: formData})
    .then(r => r.json())
    .then(d => {
        if(d.exito) { alert(d.mensaje); location.reload(); }
        else alert('Error: ' + d.mensaje);
    });
}

window.addEventListener('beforeunload', function (e) {
    if (parseInt(document.getElementById('contadorCambios').textContent) > 0) {
        e.preventDefault(); e.returnValue = '';
    }
});
</script>
{% endblock %}
